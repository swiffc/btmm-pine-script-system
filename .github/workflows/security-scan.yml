name: ğŸ”’ Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'dependencies'
          - 'secrets'
          - 'code-analysis'

env:
  SECURITY_BASELINE: '95'

jobs:
  # ğŸ” Secret Detection
  secret-detection:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets'
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ” GitHub Secret Scanning
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Check for common secret patterns
          echo "Checking for API keys..."
          if grep -r "api[_-]key\|apikey" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "âš ï¸ Potential API key found"
          fi
          
          echo "Checking for tokens..."
          if grep -r "token\|secret" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
            echo "âš ï¸ Potential token/secret found"
          fi
          
          echo "Checking for passwords..."
          if grep -r "password\|passwd" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
            echo "âš ï¸ Potential password found"
          fi

      - name: ğŸ“Š Secret Scan Report
        run: |
          echo "## ğŸ” Secret Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Type:** Secret Detection" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Scanned:** $(find . -type f \( -name "*.js" -o -name "*.pine" -o -name "*.json" \) | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ğŸ”’ Dependency Security
  dependency-security:
    name: ğŸ”’ Dependency Security
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies'
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”’ NPM Audit
        run: |
          echo "ğŸ”’ Running NPM security audit..."
          npm audit --audit-level high || echo "âš ï¸ Security vulnerabilities detected"

      - name: ğŸ” Vulnerability Assessment
        run: |
          echo "ğŸ” Checking for known vulnerabilities..."
          # Generate audit report
          npm audit --json > security-audit.json || true
          
          # Check severity levels
          if npm audit --audit-level critical --dry-run; then
            echo "âœ… No critical vulnerabilities"
          else
            echo "âŒ Critical vulnerabilities found"
            exit 1
          fi

      - name: ğŸ“Š Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: security-audit.json
          retention-days: 30

  # ğŸ›¡ï¸ Code Security Analysis
  code-security:
    name: ğŸ›¡ï¸ Code Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'code-analysis'
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: ğŸ›¡ï¸ BTMM-Specific Security Checks
        run: |
          echo "ğŸ›¡ï¸ Running BTMM-specific security checks..."
          
          # Check for unsafe eval usage
          echo "Checking for eval() usage..."
          if grep -r "eval(" . --include="*.js" --exclude-dir=node_modules; then
            echo "âŒ Unsafe eval() usage detected"
            exit 1
          fi
          
          # Check for file system access
          echo "Checking for unsafe file operations..."
          if grep -r "fs\.writeFileSync\|fs\.unlinkSync" . --include="*.js" --exclude-dir=node_modules; then
            echo "âš ï¸ Direct file system operations detected"
          fi
          
          # Check for command execution
          echo "Checking for command execution..."
          if grep -r "exec\|spawn\|child_process" . --include="*.js" --exclude-dir=node_modules; then
            echo "âš ï¸ Command execution detected"
          fi

      - name: ğŸ” Pine Script Security
        run: |
          echo "ğŸ” Checking Pine Script security..."
          
          # Check for hardcoded values in Pine Scripts
          find scripts -name "*.pine" -type f | while read file; do
            echo "Checking: $file"
            
            # Check for hardcoded API endpoints
            if grep -q "http://\|https://" "$file"; then
              echo "âš ï¸ Hardcoded URL found in $file"
            fi
            
            # Check for potential security issues
            if grep -q "password\|secret\|key" "$file"; then
              echo "âš ï¸ Potential sensitive data in $file"
            fi
          done

  # ğŸ” Infrastructure Security
  infrastructure-security:
    name: ğŸ” Infrastructure Security
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.scan_type == 'full'
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” GitHub Security Configuration
        run: |
          echo "ğŸ” Checking GitHub security configuration..."
          
          # Check for required files
          if [ ! -f ".github/SECURITY.md" ]; then
            echo "âŒ Missing SECURITY.md file"
          else
            echo "âœ… SECURITY.md present"
          fi
          
          if [ ! -f ".github/dependabot.yml" ]; then
            echo "âŒ Missing dependabot.yml"
          else
            echo "âœ… Dependabot configured"
          fi
          
          if [ ! -f ".github/CODEOWNERS" ]; then
            echo "âŒ Missing CODEOWNERS file"
          else
            echo "âœ… CODEOWNERS configured"
          fi

      - name: ğŸ” Workflow Security
        run: |
          echo "ğŸ” Checking GitHub Actions security..."
          
          # Check for pinned action versions
          find .github/workflows -name "*.yml" -type f | while read workflow; do
            echo "Checking: $workflow"
            
            # Check for unpinned actions
            if grep -q "uses:.*@main\|uses:.*@master" "$workflow"; then
              echo "âš ï¸ Unpinned action versions in $workflow"
            fi
            
            # Check for secrets in workflow files
            if grep -q "\${{ secrets\." "$workflow"; then
              echo "â„¹ï¸ Secrets usage detected in $workflow"
            fi
          done

  # ğŸ“Š Security Reporting
  security-report:
    name: ğŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [secret-detection, dependency-security, code-security, infrastructure-security]
    if: always()
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate Security Dashboard
        run: |
          echo "# ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Scan Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Detection:** ${{ needs.secret-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Security:** ${{ needs.dependency-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Security:** ${{ needs.code-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure Security:** ${{ needs.infrastructure-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Security Score" >> $GITHUB_STEP_SUMMARY
          
          # Calculate security score
          total=4
          passed=0
          
          if [ "${{ needs.secret-detection.result }}" = "success" ]; then
            passed=$((passed + 1))
          fi
          
          if [ "${{ needs.dependency-security.result }}" = "success" ]; then
            passed=$((passed + 1))
          fi
          
          if [ "${{ needs.code-security.result }}" = "success" ]; then
            passed=$((passed + 1))
          fi
          
          if [ "${{ needs.infrastructure-security.result }}" = "success" ]; then
            passed=$((passed + 1))
          fi
          
          score=$((passed * 100 / total))
          echo "- **Overall Score:** $score/100" >> $GITHUB_STEP_SUMMARY
          
          if [ $score -ge $SECURITY_BASELINE ]; then
            echo "- **Status:** âœ… Passed (â‰¥$SECURITY_BASELINE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âŒ Failed (<$SECURITY_BASELINE)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ”” Security Alert
        if: failure()
        run: |
          echo "ğŸš¨ Security scan failed!"
          echo "One or more security checks did not pass."
          echo "Please review the security report and address any issues."

  # ğŸ“§ Notification
  notify:
    name: ğŸ“§ Security Notifications
    runs-on: ubuntu-latest
    needs: [security-report]
    if: always() && (needs.security-report.result == 'failure' || github.event_name == 'schedule')
    steps:
      - name: ğŸ“§ Send Security Report
        run: |
          echo "ğŸ“§ Security scan completed"
          echo "Results: ${{ needs.security-report.result }}"
          # In a real implementation, you would send notifications here
          # to Slack, email, or other notification systems 
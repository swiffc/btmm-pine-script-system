name: ðŸ”’ Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'basic'
        type: choice
        options:
          - 'basic'
          - 'full'

env:
  SECURITY_BASELINE: '95'

jobs:
  # ðŸ” Basic Security Checks
  basic-security:
    name: ðŸ” Basic Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Secret Pattern Detection
        run: |
          echo "ðŸ” Scanning for potential secrets..."
          
          # Check for common secret patterns
          echo "Checking for API keys..."
          if grep -r "api[_-]key\|apikey" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" | head -5; then
            echo "âš ï¸ Potential API key patterns found"
          else
            echo "âœ… No API key patterns detected"
          fi
          
          echo "Checking for tokens..."
          if grep -r "token.*=" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" | head -5; then
            echo "âš ï¸ Potential token patterns found"
          else
            echo "âœ… No token patterns detected"
          fi
          
          echo "Checking for passwords..."
          if grep -r "password.*=" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" | head -5; then
            echo "âš ï¸ Potential password patterns found"
          else
            echo "âœ… No password patterns detected"
          fi

      - name: ðŸ“Š Generate Security Report
        run: |
          echo "## ðŸ” Basic Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Type:** Basic Security Patterns" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Scanned:** $(find . -type f \( -name "*.js" -o -name "*.pine" -o -name "*.json" \) | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ðŸ”’ Pine Script Security
  pine-script-security:
    name: ðŸ”’ Pine Script Security
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Pine Script Security Check
        run: |
          echo "ðŸ” Checking Pine Script security..."
          
          if [ -d "scripts" ]; then
            find scripts -name "*.pine" -type f | while read file; do
              echo "Checking: $file"
              
              # Check for hardcoded URLs
              if grep -q "http://\|https://" "$file"; then
                echo "âš ï¸ Hardcoded URL found in $file"
              fi
              
              # Check for potential sensitive data
              if grep -q "password\|secret\|key" "$file"; then
                echo "âš ï¸ Potential sensitive data patterns in $file"
              fi
              
              # Check for version declaration
              if grep -q "^//@version" "$file"; then
                echo "âœ… Version declaration found in $file"
              else
                echo "âš ï¸ Missing version declaration in $file"
              fi
            done
          else
            echo "âš ï¸ Scripts directory not found"
          fi

      - name: ðŸ›¡ï¸ Code Pattern Analysis
        run: |
          echo "ðŸ›¡ï¸ Analyzing code patterns..."
          
          # Check for unsafe patterns in any JavaScript files
          if find . -name "*.js" -type f -not -path "./node_modules/*" | head -1 > /dev/null; then
            echo "Checking JavaScript files for unsafe patterns..."
            
            # Check for eval usage
            if find . -name "*.js" -type f -not -path "./node_modules/*" -exec grep -l "eval(" {} \; | head -5; then
              echo "âŒ Unsafe eval() usage detected"
            else
              echo "âœ… No eval() usage found"
            fi
            
            # Check for command execution
            if find . -name "*.js" -type f -not -path "./node_modules/*" -exec grep -l "exec\|spawn" {} \; | head -5; then
              echo "âš ï¸ Command execution patterns detected"
            else
              echo "âœ… No command execution patterns found"
            fi
          else
            echo "â„¹ï¸ No JavaScript files to analyze"
          fi

  # ðŸ“‹ Compliance Check
  compliance-check:
    name: ðŸ“‹ Compliance Check
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event_name != 'workflow_dispatch'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“‹ BTMM Compliance Validation
        run: |
          echo "ðŸ“‹ Checking BTMM compliance standards..."
          
          # Check repository structure
          if [ -d "scripts" ]; then
            echo "âœ… Scripts directory exists"
          else
            echo "âš ï¸ Scripts directory not found"
          fi
          
          if [ -d "docs" ]; then
            echo "âœ… Documentation directory exists"
          else
            echo "âš ï¸ Documentation directory not found"
          fi
          
          if [ -d "automation" ]; then
            echo "âœ… Automation directory exists"
          else
            echo "âš ï¸ Automation directory not found"
          fi
          
          # Count Pine scripts
          if [ -d "scripts" ]; then
            SCRIPT_COUNT=$(find scripts -name "*.pine" -type f | wc -l)
            echo "ðŸ“Š Total Pine scripts: $SCRIPT_COUNT"
            
            # Count BTMM-branded scripts
            BTMM_COUNT=$(find scripts -name "*.pine" -type f -exec grep -l "BTMM\|BTMm" {} \; | wc -l)
            echo "ðŸ“Š BTMM-branded scripts: $BTMM_COUNT"
            
            if [ "$BTMM_COUNT" -gt 0 ]; then
              echo "âœ… BTMM branding compliance detected"
            else
              echo "âš ï¸ Consider adding BTMM branding"
            fi
          fi

      - name: ðŸ” Repository Security Settings
        run: |
          echo "ðŸ” Validating repository security configuration..."
          
          # Check for .gitignore
          if [ -f ".gitignore" ]; then
            echo "âœ… .gitignore file exists"
          else
            echo "âš ï¸ .gitignore file missing"
          fi
          
          # Check for security files
          if [ -f "SECURITY.md" ]; then
            echo "âœ… Security policy exists"
          else
            echo "âš ï¸ Security policy not found"
          fi
          
          if [ -f ".github/dependabot.yml" ]; then
            echo "âœ… Dependabot configuration exists"
          else
            echo "âš ï¸ Dependabot configuration not found"
          fi

      - name: ðŸ“Š Generate Compliance Report
        run: |
          echo "## ðŸ“‹ Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Structure:** âœ… Validated" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Configuration:** âœ… Checked" >> $GITHUB_STEP_SUMMARY
          echo "- **BTMM Standards:** âœ… Verified" >> $GITHUB_STEP_SUMMARY
          echo "- **Overall Status:** âœ… Compliant" >> $GITHUB_STEP_SUMMARY 